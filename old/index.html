<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<style>
	canvas{
		position:relative;
	}
	.balloon{
		position:absolute;
		width:500px;
		min-height: 100px;
		text-align: center;
		border-radius: 30px;
		margin-left:-250px;
	}
	.zoom025{
		zoom:0.25;
	}
</style>
<body style="top:0;left:0;right:0;bottom:0;position: absolute;">
	<div id="connect-info" style="width: 300px;height:50px;position:absolute;top:0;right:0">
		<input id="user-name" type="text"/><input id="connect-btn" type="button" value="接続">
	</div>
	<div style="width:300px;height:150px;position: absolute;">
		<div id="dScreen1" style="font-size:24px;"></div>
	</div>
	<div style="position: absolute;bottom:0;left:0">
		<p>移動：クリック</p>
		<p>ジャンプ: スペースキー</p>
		<p>服の切り替え:1キー 2キー</p>
	</div>
</body>
</html>

<script type="text/javascript" src="./Photon/3rdparty/swfobject.js"></script>
<script type="text/javascript" src="./Photon/3rdparty/web_socket.js"></script>
<!--dev--><script type="text/javascript" src="./Photon/photon.js"></script>
<!--dev--><script type="text/javascript" src="./Photon/photon-lite-constants.js"></script>
<!--dev--><script type="text/javascript" src="./Photon/photon-lite.js"></script>
<!--lib--><script type="text/javascript" src="./Photon/Photon-Javascript_SDK.js"></script>

<script type="text/javascript" src="./spear_anime_1.js"></script>
<script type="text/javascript" src="./spear_anime_2.js"></script>
<script type="text/javascript" src="./spear_anime_3.js"></script>
<script type="text/javascript" src="./spear_anime_4.js"></script>
<script type="text/javascript" src="./spear_anime_5.js"></script>
<script type="text/javascript" src="./spear_anime_6.js"></script>
<script type="text/javascript" src="./spear_anime_7.js"></script>
<script type="text/javascript" src="./jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="./SsaPlayer.js"></script>
<script type="text/javascript">

	var animation_images = ['01-0.png','02.png'];
	//キャラデータ用オブジェクトを生成
	var chara_data = new Array();
	var config = {
		canvas		: {width:1500,height:1000},
		speed		: 3,
		position 	: 1		//操作するキャラの配列の位置
	};
	$(function() {
		module.init();
		setInterval(function () {

			var t = new Date().getTime();

			chara_data.forEach(function(data, key){
				data.canvas.save();
				data.canvas.clearRect(0, 0, config.canvas.width, config.canvas.height);
				data.data.draw(data.canvas, t);
				data.canvas.restore();

				//キャラクターの移動処理
				if((data.position.now.y + config.speed) < data.position.target.y){
					data.position.now.y += config.speed;
				}else if((data.position.now.y - config.speed) > data.position.target.y){
					data.position.now.y -= config.speed;
				}
				if(module.isLeft(data.position.now.x, data.position.target.x)){
					data.position.now.x -= config.speed;
					module.animationLeft(key);
				}else if(module.isRight(data.position.now.x , data.position.target.x)){
					data.position.now.x += config.speed;
					module.animationRight(key);
				}
				if(module.checkPosition(data.position.now.x, data.position.now.y, data.position.target.x, data.position.target.y) && data.move_jump == false){
					if(data.position.stop.x != data.position.now.x || data.position.stop.y != data.position.now.y) {
						module.animationEnd(key);
						data.position.stop.x = data.position.now.x;
						data.position.stop.y = data.position.now.y;
					}
				}
				data.canvas_dom.style.top = data.position.now.y * 4 + "px";
				data.canvas_dom.style.left = data.position.now.x * 4 + "px";

				//吹き出し表示テスト
				data.balloon_dom.style.top = 100+data.position.now.y * 4 + "px";
				data.balloon_dom.style.left = data.position.now.x * 4 + "px";
			});

			module.zIndex();	//重なり順判定
			module.showFps();	//FPS表示(あとで消す)
		}, 16);

		//イベントリスナー
		$("body").keypress(function (e){
			if (e.which == 32){
				module.animationJump(config.position);
				photon.sendJump();
			}
		});
		$("body").keydown(function (e){
			if (e.which == 39){
				chara_data[config.position].position.target.x = chara_data[config.position].position.now.x + 20;
				console.log("keydown");
			}else if(e.which == 37){
				chara_data[config.position].position.target.x = chara_data[config.position].position.now.x - 20;
				console.log("keydown");
			}else if(e.which == 49){
				photon.sendCostume(1);
			}else if(e.which == 50){
				photon.sendCostume(2);
				chara_data[config.position].image.setImage(0, '01-1.png');
			}
		});
		if (navigator.userAgent.indexOf('iPhone') > 0 || navigator.userAgent.indexOf('iPod') > 0 || navigator.userAgent.indexOf('Android') > 0) {
			//SP用
			$("body").bind("touchstart", function (e) {
				var click_position = {x: event.touches[0].clientX, y: event.touches[0].clientY};
				chara_data[config.position].position.target.x = click_position.x;
				chara_data[config.position].position.target.y = click_position.y;
				console.log("x:" + click_position.x + " Y:" + click_position.y);
				photon.sendMove(click_position.x, click_position.y);
			});
		}else{
			//PC用
			$("body").on("click", function (e) {
				var click_position = {x: event.clientX, y: event.clientY};
				chara_data[config.position].position.target.x = click_position.x;
				chara_data[config.position].position.target.y = click_position.y;
				console.log("x:" + click_position.x + " Y:" + click_position.y);
				photon.sendMove(click_position.x, click_position.y);
			});
		}

		$("#connect-btn").on("click", function() {
			photon.init(function() {
				photon.sendName($("#user-name").val());
				$("#connect-info").hide();
			});
		});
	});

	/**
	 * module
	 * 作ったメソッドをとりあえず置いておく
	 */
	var module = (function() {
		var frameCount = 0;
		var time = 0;
		var prevTime = new Date().getTime();
		var fps = 0;
		return {
			init:function(){

			},
			createCharacter:function(actorId){
				var image = new SsImageList(animation_images, "./", true);
				var animation = new SsAnimation(spear_anime_idol_animation, image);
				var data = new SsSprite(animation);
				data.setLoop(0);
				var canvas_dom = $('<canvas class="zoom025" width="1500" height="1000" style="margin-left:-750px;margin-top:-900px;position:absolute;"></canvas>');
				var balloon_dom = $('<div class="balloon zoom025" />');
				canvas_dom = canvas_dom.appendTo($("body")).get(0);
				balloon_dom = balloon_dom.appendTo($("body")).get(0);
				var canvas = canvas_dom.getContext("2d");
				chara_data[actorId] = {
					image: image,
					animation: animation,
					data: data,
					canvas:canvas,
					canvas_dom:canvas_dom,
					balloon_dom:balloon_dom,
					move_left:false,
					move_right:false,
					move_jump:false,
					position:{
						now:{x:0, y:0},
						target:{x:0, y:0},
						stop:{x:0, y:0}
					}
				};
			},
			animationRight:function(position){
				var character = chara_data[position];
				character.move_right = false;
				if(character.move_left == true) return;
				$(character.canvas_dom).css("-webkit-transform", "scaleX(1)");
				character.animeation = new SsAnimation(spear_anime_ran_animation, character.image);
				character.data.setLoop(0);
				character.data.setAnimation(character.animeation);
				character.move_left = true;
			},
			animationLeft:function(position){
				var character = chara_data[position];
				character.move_left = false;
				if(character.move_right == true) return;
				$(character.canvas_dom).css("-webkit-transform", "scaleX(-1)");
				character.animeation = new SsAnimation(spear_anime_ran_animation, character.image);
				character.data.setLoop(0);
				character.data.setAnimation(character.animeation);
				character.move_right = true;
			},
			animationEnd:function(position){
				var character = chara_data[position];
				character.animeation = new SsAnimation(spear_anime_idol_animation, character.image);
				character.data.setLoop(0);
				character.data.setAnimation(character.animeation);
				character.move_left = false;
				character.move_right = false;
			},
			animationJump:function(position){
				var character = chara_data[position];
				character.animeation = new SsAnimation(spear_anime_jump_animation, character.image);
				character.data.setLoop(1);
				character.move_jump = true;
				character.data.setEndCallBack(function(){
					if(character.move_left == true){
						$(character.canvas_dom).css("-webkit-transform", "scaleX(1)");
						character.animeation = new SsAnimation(spear_anime_ran_animation, character.image);
					}else if(character.move_right == true){
						$(character.canvas_dom).css("-webkit-transform", "scaleX(-1)");
						character.animeation = new SsAnimation(spear_anime_ran_animation, character.image);
					}else{
						character.animeation = new SsAnimation(spear_anime_idol_animation, character.image);
					}
					character.move_jump = false;
					character.data.setAnimation(character.animeation);
					character.data.setLoop(0);
				});
				character.data.setAnimation(character.animeation);
			},
			changeCostume:function(position, mode){
				var character = chara_data[position];
				if(mode == "1") {
					character.image.setImage(0, '01-0.png');
				}else if(mode == "2"){
					character.image.setImage(0, '01-1.png');
				}
			},
			checkPosition:function(now_x, now_y, target_x, target_y){
				if(((now_x + config.speed) >= target_x && (now_x - config.speed) <= target_x) && ((now_y + config.speed) >= target_y && (now_y - config.speed) <= target_y)){
					return true;
				}else{
					return false;
				}
			},
			isRight:function(now_x, target_x){
				if(((now_x + config.speed) < target_x)){
					return true;
				}else{
					return false;
				}
			},
			isLeft:function(now_x, target_x){
				if(((now_x - config.speed) > target_x)){
					return true;
				}else{
					return false;
				}
			},
			//重なり順判定
			zIndex:function(){
				chara_data.forEach(function(data, key){
					data.canvas_dom.style.zIndex = data.position.now.y;
				});
			},
			showFps:function(){
				time = new Date().getTime();

				++frameCount;
				if (time > prevTime + 1000) {
					prevTime = time;
					fps = frameCount;
					frameCount = 0;
				}

				document.getElementById("dScreen1").innerHTML = "FPS: " + ~~(fps);
			}
		};
	})();
	/**
	 * photon
	 * photonメソッドをとりあえず置いておく
	 */
	var photon = (function() {
		// 接続先URI
		var uri = "ws://52.10.247.156:9090/";

		// photon socketオブジェクト
		var peer = null;
		return {
			// 初期処理
			init:function(callback) {
				// 接続
				photon.peer = new Photon.Lite.LitePeer(uri);

				// Set event handlers.
				photon.peer.addPeerStatusListener(Photon.PhotonPeer.StatusCodes.connect, function () {
					photon.chat("Connected!");
					photon.peer.join('test1');
				});
				photon.peer.addResponseListener(Photon.Lite.Constants.LiteOpCode.Join, function (e) {
					photon.chat('I joined with id: [' + e.actorNr + '].');
					config.position = e.actorNr;
					module.createCharacter(e.actorNr);
					callback();
				});
				photon.peer.addEventListener(Photon.Lite.Constants.LiteEventCode.Join, function (e) {
					for (var i = 0; i < e.newActors.length; i++) {
						if (e.newActors[i] != photon.peer.myActor().photonId) {
							module.createCharacter(e.newActors[i]);
							//誰かが入室したタイミングで自分の現在の座標を送信
							photon.sendMove(chara_data[config.position].position.target.x, chara_data[config.position].position.target.y);
							photon.sendName(chara_data[config.position].balloon_dom.innerHTML);
							photon.chat('actor[' + e.newActors[i] + '] joined!');
						}
					}
				});
				photon.peer.addEventListener(Photon.Lite.Constants.LiteEventCode.Leave, function (e) {
					$(chara_data[e.actorNr].canvas_dom).remove();
					$(chara_data[e.actorNr].balloon_dom).remove();
					delete chara_data[e.actorNr];
					photon.chat('actor[' + e.actorNr + '] left!');
				});
				photon.peer.addEventListener(1, function (data) {
					var json = JSON.parse(arguments[0].vals[Photon.Lite.Constants.LiteOpKey.Data].message);
					var actorNr = arguments[0].vals[Photon.Lite.Constants.LiteOpKey.ActorNr];
					if(json.mode == "message"){
						photon.chat('actor[' + actorNr + ']message: ' + json.data.text);
					}else if(json.mode == "move"){
						photon.chat('actor[' + actorNr + ']move: ' + ' x:'+json.data.x+'y:'+json.data.y);
						chara_data[actorNr].position.target.x = json.data.x;
						chara_data[actorNr].position.target.y = json.data.y;
					}else if(json.mode == "name"){
						photon.chat('actor[' + actorNr + ']name: ' + ' name:'+json.data.name);
						chara_data[actorNr].balloon_dom.innerHTML = json.data.name;
					}else if(json.mode == "jump"){
						photon.chat('actor[' + actorNr + ']jump');
						module.animationJump(actorNr);
					}else if(json.mode == "costume"){
						photon.chat('actor[' + actorNr + ']costume:' + json.data.mode);
						module.changeCostume(actorNr, json.data.mode);
					}

				});

				photon.peer.connect();
			},
			// 切断イベント
			close:function() {
				photon.peer.disconnect();
				photon.chat("Disconnected!");
			},
			_send:function(message){
				try  {
					photon.peer.raiseEvent(1, { message: String(message) });
					photon.chat('me[' + photon.peer.myActor().photonId + ']: ' + message);
				} catch (err) {
					photon.chat("error: " + err.message);
				}
			},
			sendMessage:function(message){
				photon._send(JSON.stringify({mode:"message",data:{text:message}}));
			},
			sendMove:function(x, y){
				photon._send(JSON.stringify({mode:"move",data:{x:x, y:y}}));
			},
			sendJump:function(){
				photon._send(JSON.stringify({mode:"jump",data:{}}));
			},
			sendName:function(name){
				photon._send(JSON.stringify({mode:"name",data:{name:name}}));
				chara_data[config.position].balloon_dom.innerHTML = name;
			},
			sendCostume:function(num){
				photon._send(JSON.stringify({mode:"costume",data:{mode:num}}));
				module.changeCostume(config.position, num);
			},
			// チャットに表示
			chat:function(message) {
				//Todo::とりあえずログに表示しているけどそのうちチャット機能を用意する
				console.log(message);
			}
		};
	})();
</script>
